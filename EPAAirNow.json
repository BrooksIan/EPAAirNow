{"paragraphs":[{"text":"%md\n\n## Data Science In Apache Spark\n### EPA Air Now\n\n**Language**: Scala\n**Requirements**: \n- [HDP 2.6.X]\n- Spark 2.x\n\n**Author**: Ian Brooks\n**Follow** [LinkedIn - Ian Brooks PhD] (https://www.linkedin.com/in/ianrbrooksphd/)\n**Source Data** [EPA Air Now Search Site](https://aqs.epa.gov/api)\n**Addtional Information**: \n\n**File Upload:** Upload the source data json  files to HDFS in the /tmp directory\n\n![AirNow](http://www.sonomatech.com/sites/default/files/Plain_large_T.png \"EPA Air Now\")","dateUpdated":"2018-12-07T12:54:28-0800","config":{"tableHide":false,"editorSetting":{"language":"markdown","editOnDblClick":true},"colWidth":12,"editorMode":"ace/mode/markdown","editorHide":false,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1544216018585_1988173282","id":"20181101-134841_1602903440","dateCreated":"2018-12-07T12:53:38-0800","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:3564"},{"title":"Load Dependency Library ","text":"%spark2.dep \n\nz.load(\"com.databricks:spark-csv_2.11:1.5.0\")\n","dateUpdated":"2018-12-07T12:53:38-0800","config":{"editorSetting":{"language":"scala","editOnDblClick":false},"colWidth":12,"editorMode":"ace/mode/scala","editorHide":false,"title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1544216018590_1987788533","id":"20181101-135228_262536942","dateCreated":"2018-12-07T12:53:38-0800","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:3565"},{"title":"Download Data Files and Copy To HDFS","text":"%sh\n\n\n# Download Data from Github\nwget https://raw.githubusercontent.com/BrooksIan/EPAAirNow/master/AQDM_358425767.txt -O /tmp/AQDM_358425767.txt\n\n# Make HDFS Directory and Load CSV files into HDFS\nhadoop fs -mkdir /tmp/\nhadoop fs -put /tmp/AQDM_358425767.txt /tmp/AQDM_358425767.txt\n\nhadoop fs -ls /tmp/AQDM*\n","dateUpdated":"2018-12-07T12:55:43-0800","config":{"editorSetting":{"language":"sh","editOnDblClick":false},"colWidth":12,"editorMode":"ace/mode/sh","editorHide":false,"title":true,"results":{},"enabled":false},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1544216018591_1987403784","id":"20181130-081036_1002586778","dateCreated":"2018-12-07T12:53:38-0800","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:3566"},{"title":"Initialize Spark Session","text":"%spark2\n\nimport org.apache.spark.sql.SparkSession\nval spark: SparkSession = SparkSession.builder\n  .appName(\"SBIR\")  // optional and will be autogenerated if not specified\n  .master(\"local[*]\")               // avoid hardcoding the deployment environment\n  .enableHiveSupport()              // self-explanatory, isn't it?\n  .config(\"spark.sql.warehouse.dir\", \"target/spark-warehouse\")\n  .getOrCreate\n\nspark.version\n","dateUpdated":"2018-12-07T12:53:38-0800","config":{"editorSetting":{"language":"scala","editOnDblClick":false},"colWidth":12,"editorMode":"ace/mode/scala","title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1544216018592_1973168075","id":"20181101-135113_950238278","dateCreated":"2018-12-07T12:53:38-0800","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:3567"},{"title":"Load Data File, Build Dataframe, and Create Table View","text":"%spark2\n\nimport org.apache.spark.sql.types._\nimport org.apache.spark.sql.DataFrame\nimport scala.collection.mutable.ListBuffer\n\n//Create a data frame from CSV File \nval df_WholeSetRaw = sqlContext.read.format(\"com.databricks.spark.csv\").option(\"header\", \"true\").option(\"inferSchema\", \"true\").load(\"/tmp/AQDM_358425767.txt\")\n\n//df_WholeSetRaw.cache()\n\n//Create Table from DataFrame\n//df_WholeSetRaw.createOrReplaceTempView(\"EPAAIRNOW\")\n\n//Display resulting Infered schema \ndf_WholeSetRaw.printSchema()","dateUpdated":"2018-12-07T12:53:38-0800","config":{"editorSetting":{"language":"scala"},"colWidth":12,"editorMode":"ace/mode/scala","title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1544216018594_1973937573","id":"20181101-135144_252459906","dateCreated":"2018-12-07T12:53:38-0800","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:3568"},{"title":"Cast DateTime into TimeStamp","text":"%spark2\n\nimport org.apache.spark.sql.functions.{to_date, to_timestamp}\n\nval modifiedDF = df_WholeSetRaw.withColumn(\"DateSub\", expr(\"substring(datetime, 1, length(datetime)-5)\") )\n\n\nval modifiedDF1 = modifiedDF.withColumn(\"timestamp\", unix_timestamp($\"DateSub\", \"yyyymmdd'T'kkmm\").cast(TimestampType))\n\nmodifiedDF1.cache()\nmodifiedDF1.printSchema()\nmodifiedDF1.take(1)\n\nmodifiedDF1.createOrReplaceTempView(\"EPAAIRNOW\")\n","dateUpdated":"2018-12-07T12:53:38-0800","config":{"editorSetting":{"language":"scala"},"colWidth":12,"editorMode":"ace/mode/scala","title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1544216018595_1973552824","id":"20181207-102416_649987066","dateCreated":"2018-12-07T12:53:38-0800","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:3569"},{"title":"Query Raw Table","text":"%spark2.sql\n\nselect * from EPAAIRNOW limit 100\n","dateUpdated":"2018-12-07T12:53:38-0800","config":{"editorSetting":{"language":"sql","editOnDblClick":false},"colWidth":12,"editorMode":"ace/mode/sql","title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1544216018596_1971629079","id":"20181101-135753_1679218347","dateCreated":"2018-12-07T12:53:38-0800","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:3570"},{"title":"Records By Site","text":"%sql\n\nselect site, count(site) from EPAAIRNOW group by site\n","dateUpdated":"2018-12-07T12:53:38-0800","config":{"editorSetting":{"language":"sql","editOnDblClick":false},"colWidth":4,"editorMode":"ace/mode/sql","editorHide":false,"title":true,"results":{"0":{"graph":{"mode":"multiBarChart","height":300,"optionOpen":false},"helium":{}}},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1544216018597_1971244330","id":"20181101-141125_1067785878","dateCreated":"2018-12-07T12:53:38-0800","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:3571"},{"title":"Records By Action Code","text":"%sql\n\nselect action_code, count(action_code) from EPAAIRNOW group by action_code\n","dateUpdated":"2018-12-07T12:53:38-0800","config":{"editorSetting":{"language":"sql","editOnDblClick":false},"colWidth":4,"editorMode":"ace/mode/sql","editorHide":false,"title":true,"results":{"0":{"graph":{"mode":"pieChart","height":291.974,"optionOpen":false,"setting":{"pieChart":{}},"commonSetting":{},"keys":[{"name":"action_code","index":0,"aggr":"sum"}],"groups":[],"values":[{"name":"count(action_code)","index":1,"aggr":"sum"}]},"helium":{}},"1":{"graph":{"mode":"table","height":300,"optionOpen":false}}},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1544216018599_1972013828","id":"20181101-141412_707088412","dateCreated":"2018-12-07T12:53:38-0800","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:3572"},{"title":"Records By GISDatum ","text":"%sql\n\nselect GISDatum, count(GISDatum) from EPAAIRNOW group by GISDatum\n","dateUpdated":"2018-12-07T12:53:38-0800","config":{"editorSetting":{"language":"sql","editOnDblClick":false},"colWidth":4,"editorMode":"ace/mode/sql","editorHide":false,"title":true,"results":{"0":{"graph":{"mode":"pieChart","height":291.974,"optionOpen":false,"setting":{"pieChart":{}},"commonSetting":{},"keys":[{"name":"GISDatum","index":0,"aggr":"sum"}],"groups":[],"values":[{"name":"count(GISDatum)","index":1,"aggr":"sum"}]},"helium":{}},"1":{"graph":{"mode":"table","height":300,"optionOpen":false}}},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1544216018600_1970090084","id":"20181207-105644_1717288977","dateCreated":"2018-12-07T12:53:38-0800","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:3573"},{"title":"Records By Method Code","text":"%sql\n\nselect method_code, count(method_code) from EPAAIRNOW group by method_code\n","dateUpdated":"2018-12-07T12:53:38-0800","config":{"editorSetting":{"language":"sql","editOnDblClick":false},"colWidth":4,"editorMode":"ace/mode/sql","editorHide":false,"title":true,"results":{"0":{"graph":{"mode":"pieChart","height":291.974,"optionOpen":false,"setting":{"pieChart":{}},"commonSetting":{},"keys":[{"name":"method_code","index":0,"aggr":"sum"}],"groups":[],"values":[{"name":"count(method_code)","index":1,"aggr":"sum"}]},"helium":{}},"1":{"graph":{"mode":"table","height":300,"optionOpen":false}}},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1544216018601_1969705335","id":"20181207-110347_717832730","dateCreated":"2018-12-07T12:53:38-0800","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:3574"},{"title":"Records By Parameter Code","text":"%sql\n\nselect parameter, count(parameter) from EPAAIRNOW group by parameter\n","dateUpdated":"2018-12-07T12:53:38-0800","config":{"editorSetting":{"language":"sql","editOnDblClick":false},"colWidth":4,"editorMode":"ace/mode/sql","editorHide":false,"title":true,"results":{"0":{"graph":{"mode":"pieChart","height":291.974,"optionOpen":false,"setting":{"pieChart":{}},"commonSetting":{},"keys":[{"name":"parameter","index":0,"aggr":"sum"}],"groups":[],"values":[{"name":"count(parameter)","index":1,"aggr":"sum"}]},"helium":{}},"1":{"graph":{"mode":"table","height":300,"optionOpen":false}}},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1544216018602_1970859581","id":"20181207-110424_809414785","dateCreated":"2018-12-07T12:53:38-0800","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:3575"},{"title":"Records By Ele","text":"%sql\n\nselect elev, count(elev) from EPAAIRNOW group by elev\n","dateUpdated":"2018-12-07T12:53:38-0800","config":{"editorSetting":{"language":"sql","editOnDblClick":false},"colWidth":4,"editorMode":"ace/mode/sql","editorHide":false,"title":true,"results":{"0":{"graph":{"mode":"multiBarChart","height":291.974,"optionOpen":false,"setting":{"pieChart":{}},"commonSetting":{},"keys":[{"name":"elev","index":0,"aggr":"sum"}],"groups":[],"values":[{"name":"count(elev)","index":1,"aggr":"sum"}]},"helium":{}},"1":{"graph":{"mode":"table","height":300,"optionOpen":false}}},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1544216018603_1970474832","id":"20181207-110717_1022089094","dateCreated":"2018-12-07T12:53:38-0800","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:3576"},{"title":"AirQuality Value From Sites By Timestamp","text":"%sql\n\nselect timestamp, value, site from EPAAIRNOW where value > 0 group by timestamp, value, site limit 1000\n","dateUpdated":"2018-12-07T12:53:38-0800","config":{"editorSetting":{"language":"sql","editOnDblClick":false},"colWidth":12,"editorMode":"ace/mode/sql","editorHide":false,"title":true,"results":{"0":{"graph":{"mode":"lineChart","height":384,"optionOpen":false,"setting":{"pieChart":{},"scatterChart":{"xAxis":{"name":"timestamp","index":0,"aggr":"sum"},"yAxis":{"name":"value","index":2,"aggr":"sum"}},"lineChart":{}},"keys":[{"name":"timestamp","index":0,"aggr":"sum"}],"groups":[{"name":"site","index":2,"aggr":"sum"}],"values":[{"name":"value","index":1,"aggr":"max"}],"commonSetting":{}},"helium":{}},"1":{"graph":{"mode":"table","height":300,"optionOpen":false}}},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1544216018604_1968551088","id":"20181101-141514_1152598520","dateCreated":"2018-12-07T12:53:38-0800","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:3577"},{"title":"AirQuality Value Min, Max, & Avg From All Sites By Date","text":"%sql\n\nselect dayofyear(timestamp), avg(value), min(value), max(value) from EPAAIRNOW group by timestamp, value limit 1000\n","dateUpdated":"2018-12-07T12:53:38-0800","config":{"editorSetting":{"language":"sql"},"colWidth":12,"editorMode":"ace/mode/sql","title":true,"results":{"0":{"graph":{"mode":"lineChart","height":300,"optionOpen":false,"setting":{"lineChart":{}},"commonSetting":{},"keys":[{"name":"dayofyear(CAST(timestamp AS DATE))","index":0,"aggr":"sum"}],"groups":[],"values":[{"name":"avg(value)","index":1,"aggr":"avg"},{"name":"min(value)","index":2,"aggr":"min"},{"name":"max(value)","index":3,"aggr":"max"}]},"helium":{}}},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1544216018606_1969320586","id":"20181207-112443_125366151","dateCreated":"2018-12-07T12:53:38-0800","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:3578"},{"title":"Air Quality Value Date: Jan 5 2018 From All Sites","text":"%sql\n\nselect timestamp, value, site from EPAAIRNOW where dayofyear(timestamp) = 5 and value > 10 group by timestamp, value, site limit 1000","dateUpdated":"2018-12-07T12:53:38-0800","config":{"editorSetting":{"language":"sql"},"colWidth":12,"editorMode":"ace/mode/sql","title":true,"results":{"0":{"graph":{"mode":"lineChart","height":300,"optionOpen":false,"setting":{"lineChart":{}},"commonSetting":{},"keys":[{"name":"timestamp","index":0,"aggr":"sum"}],"groups":[{"name":"site","index":2,"aggr":"sum"}],"values":[{"name":"value","index":1,"aggr":"avg"}]},"helium":{}}},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1544216018608_1979324057","id":"20181207-113931_999186323","dateCreated":"2018-12-07T12:53:38-0800","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:3579"},{"text":"%sql\n","dateUpdated":"2018-12-07T12:53:38-0800","config":{"colWidth":12,"editorMode":"ace/mode/sql","results":{},"enabled":true,"editorSetting":{"language":"sql"}},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1544216018609_1978939308","id":"20181207-114435_1949499767","dateCreated":"2018-12-07T12:53:38-0800","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:3580"},{"title":"AirQuality Value By Timestamp From Two Sites","text":"%sql\n\nselect timestamp, value, site from EPAAIRNOW where site = 840480430101 or site = 840482450101 group by timestamp, value, site limit 1000\n","dateUpdated":"2018-12-07T12:53:38-0800","config":{"editorSetting":{"language":"sql","editOnDblClick":false},"colWidth":12,"editorMode":"ace/mode/sql","editorHide":false,"title":true,"results":{"0":{"graph":{"mode":"lineChart","height":384,"optionOpen":false,"setting":{"pieChart":{},"scatterChart":{"xAxis":{"name":"timestamp","index":0,"aggr":"sum"},"yAxis":{"name":"value","index":2,"aggr":"sum"}},"lineChart":{}},"keys":[{"name":"timestamp","index":0,"aggr":"sum"}],"groups":[{"name":"site","index":2,"aggr":"sum"}],"values":[{"name":"value","index":1,"aggr":"max"}],"commonSetting":{}},"helium":{}},"1":{"graph":{"mode":"table","height":300,"optionOpen":false}}},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1544216018611_1979708806","id":"20181207-111803_1783305135","dateCreated":"2018-12-07T12:53:38-0800","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:3581"},{"title":"MPC Values (Min, Max, Avg) By Timestamp From All Sites","text":"%sql\n\nselect timestamp, site, mpc_value from EPAAIRNOW group by timestamp, mpc_value, site limit 1000 \n","dateUpdated":"2018-12-07T12:53:38-0800","config":{"editorSetting":{"language":"sql","editOnDblClick":false},"colWidth":12,"editorMode":"ace/mode/sql","editorHide":false,"title":true,"results":{"0":{"graph":{"mode":"lineChart","height":384,"optionOpen":false,"setting":{"pieChart":{},"scatterChart":{"xAxis":{"name":"timestamp","index":0,"aggr":"sum"},"yAxis":{"name":"value","index":2,"aggr":"sum"}},"lineChart":{}},"keys":[{"name":"timestamp","index":0,"aggr":"sum"}],"groups":[],"values":[{"name":"mpc_value","index":2,"aggr":"max"},{"name":"mpc_value","index":2,"aggr":"min"},{"name":"mpc_value","index":2,"aggr":"avg"}],"commonSetting":{}},"helium":{}},"1":{"graph":{"mode":"table","height":300,"optionOpen":false}}},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1544216018613_1977400313","id":"20181207-105715_1917558884","dateCreated":"2018-12-07T12:53:38-0800","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:3582"},{"title":"MPC Value By Timestamp From Two Sites","text":"%sql\n\nselect timestamp,  mpc_value, site from EPAAIRNOW  where site = 840480430101 or site = 840482450102 group by timestamp, mpc_value, site limit 1000\n","dateUpdated":"2018-12-07T12:53:38-0800","config":{"editorSetting":{"language":"sql","editOnDblClick":false},"colWidth":12,"editorMode":"ace/mode/sql","editorHide":false,"title":true,"results":{"0":{"graph":{"mode":"lineChart","height":384,"optionOpen":false,"setting":{"pieChart":{},"scatterChart":{"xAxis":{"name":"timestamp","index":0,"aggr":"sum"},"yAxis":{"name":"value","index":2,"aggr":"sum"}},"lineChart":{}},"keys":[{"name":"timestamp","index":0,"aggr":"sum"}],"groups":[{"name":"site","index":2,"aggr":"sum"}],"values":[{"name":"mpc_value","index":1,"aggr":"max"}],"commonSetting":{}},"helium":{}},"1":{"graph":{"mode":"table","height":300,"optionOpen":false}}},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1544216018615_1978169810","id":"20181207-111925_2029995364","dateCreated":"2018-12-07T12:53:38-0800","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:3583"},{"text":"%sql\n","dateUpdated":"2018-12-07T12:53:38-0800","config":{"colWidth":12,"editorMode":"ace/mode/sql","results":{},"enabled":true,"editorSetting":{"language":"sql"}},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1544216018620_1974707070","id":"20181102-081010_156471413","dateCreated":"2018-12-07T12:53:38-0800","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:3585"}],"name":"EPA Air Now","id":"2DXVB2A4R","angularObjects":{"2CHS8UYQQ:shared_process":[],"2CKX6DGQZ:shared_process":[],"2C8A4SZ9T_livy2:shared_process":[],"2CK8A9MEG:shared_process":[],"2CKX8WPU1:shared_process":[],"2C4U48MY3_spark2:shared_process":[],"2CKAY1A8Y:shared_process":[],"2CKEKWY8Z:shared_process":[]},"config":{"isZeppelinNotebookCronEnable":false,"looknfeel":"default","personalizedMode":"false"},"info":{}}